#include <memory.h>
#include "usb_command.h"

// Command structure:
// +---------+---------------------+-------------+-------------------------------------------+
// | Index   | Description         | Value       | Effect                                    |
// +---------+---------------------+-------------+-------------------------------------------+
// | 0       | -                   | 0xB0        | Read radio parameters                     |
// +---------+---------------------+-------------+-------------------------------------------+
// | 8-63    | Don't care          | Any Value   | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
//
// Command response:
// +---------+---------------------+-------------+-------------------------------------------+
// | Index   | Description         | Value       | Effect                                    |
// +---------+---------------------+-------------+-------------------------------------------+
// | 0       | -                   | 0xB0        | Command echo                              |
// +---------+---------------------+-------------+-------------------------------------------+
// | 1       | -                   | 0x00        | Command completed successfully            |
// |         |                     | 0x01        | Command not completed successfully        |
// +---------+---------------------+-------------+-------------------------------------------+
// | 2       | High address byte   | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 3       | Low address byte    | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 4       | Data and UART       | -           | -                                         |
// |         | settings            |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 5       | Various control     | -           | -                                         |
// |         | options             |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 6       | Radio channel       | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 7       | Various control     | -           | -                                         |
// |         | options             |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 8-63    | Don't care          | Any Value   | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
bool usb_command_read_params(radio_inst_t const *radio, uint8_t *response, uint8_t const *buffer, uint32_t bufsize) {
    (void) bufsize;
    (void) buffer;

    parameters_t *params = (parameters_t *) &response[2];

    set_radio_uart_config_mode(radio);
    if (!read_parameters(radio, params)) {
        response[1] = USB_COMMAND_FAILED;
        return false;
    }

    response[1] = USB_COMMAND_SUCCESS;

    // Adjust UART
    set_radio_uart(radio, params->sped);
    return true;
}

// Command structure:
// +---------+---------------------+-------------+-------------------------------------------+
// | Index   | Description         | Value       | Effect                                    |
// +---------+---------------------+-------------+-------------------------------------------+
// | 0       | -                   | 0xB1        | Write radio parameters                    |
// +---------+---------------------+-------------+-------------------------------------------+
// | 1       | How set radio       | 0x00        | Temporary                                 |
// |         | registers           | 0x01        | Permanent                                 |
// +---------+---------------------+-------------+-------------------------------------------+
// | 2       | High address byte   | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 3       | Low address byte    | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 4       | Data and UART       | -           | -                                         |
// |         | settings            |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 5       | Various control     | -           | -                                         |
// |         | options             |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 6       | Radio channel       | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 7       | Various control     | -           | -                                         |
// |         | options             |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 8-63    | Don't care          | Any Value   | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
//
// Command response:
// +---------+---------------------+-------------+-------------------------------------------+
// | Index   | Description         | Value       | Effect                                    |
// +---------+---------------------+-------------+-------------------------------------------+
// | 0       | -                   | 0xB0        | Command echo                              |
// +---------+---------------------+-------------+-------------------------------------------+
// | 1       | -                   | 0x00        | Command completed successfully            |
// |         |                     | 0x01        | Command not completed successfully        |
// +---------+---------------------+-------------+-------------------------------------------+
// | 2       | High address byte   | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 3       | Low address byte    | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 4       | Data and UART       | -           | -                                         |
// |         | settings            |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 5       | Various control     | -           | -                                         |
// |         | options             |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 6       | Radio channel       | -           | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+
// | 7       | Various control     | -           | -                                         |
// |         | options             |             |                                           |
// +---------+---------------------+-------------+-------------------------------------------+
// | 8-63    | Don't care          | Any Value   | -                                         |
// +---------+---------------------+-------------+-------------------------------------------+

bool usb_command_write_params(radio_inst_t const *radio, uint8_t *response, uint8_t const *buffer, uint32_t bufsize) {
    // No enough bytes in the request
    if (bufsize < sizeof(parameters_t) + 2) {
        response[1] = USB_COMMAND_FAILED;
        return false;
    }

    parameters_t const *params = (parameters_t const *) &buffer[2];
    bool save = buffer[1];

    set_radio_uart_config_mode(radio);
    if (!write_parameters(radio, params, save)) {
        response[1] = USB_COMMAND_FAILED;
        return false;
    }

    response[1] = USB_COMMAND_SUCCESS;
    memcpy(&response[2], params, sizeof(parameters_t));

    // Adjust UART
    set_radio_uart(radio, params->sped);
    return true;
}